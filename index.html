<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Calorie & Meal Planner</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --white: #fff;
      --black: #222;
      --gray: #f8f9fa;
      --light-bg: #f9f8ff;
      --dark-bg: #21223b;
      --dark-card: #292a3d;
      --dark-text: #eaeafd;
      --highlight: #ffae42;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      min-height: 100vh;
      color: var(--black);
      transition: background 0.4s, color 0.4s;
    }
    [data-theme="dark"] body {
      background: var(--dark-bg);
      color: var(--dark-text);
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }
    .app-header {
      text-align: center;
      margin-bottom: 30px;
      color: var(--white);
    }
    .app-header h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 7px rgba(0,0,0,0.13);
    }
    .card {
      background: rgba(255,255,255,0.97);
      border-radius: 18px;
      padding: 28px 22px;
      margin-bottom: 22px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.09);
      border: 1px solid rgba(255,255,255,0.17);
      position: relative;
      transition: background 0.4s, color 0.4s;
    }
    [data-theme="dark"] .card {
      background: var(--dark-card);
      color: var(--dark-text);
      border: 1px solid #38396c;
    }
    .form-group { margin-bottom: 16px; }
    label {
      display: block;
      margin-bottom: 7px;
      font-weight: 500;
      color: #4b4b4b;
    }
    [data-theme="dark"] label { color: var(--dark-text); }
    input, select, textarea {
      width: 100%;
      padding: 11px 14px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 15px;
      background: var(--white);
      color: var(--black);
      transition: border-color 0.3s, background 0.4s, color 0.4s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(102,126,234,0.10);
    }
    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background: #26273e;
      color: var(--dark-text);
      border: 2px solid #333455;
    }
    .btn {
      padding: 11px 20px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--white);
    }
    .btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.21);
    }
    .btn-secondary {
      background: var(--gray);
      color: #444;
      border: 2px solid #e1e5e9;
    }
    .btn-secondary:hover {
      background: #e9ecef;
    }
    [data-theme="dark"] .btn-secondary {
      background: #242545;
      color: var(--dark-text);
      border: 2px solid #343656;
    }
    [data-theme="dark"] .btn-secondary:hover {
      background: #32345d;
    }
    .hidden { display: none !important; }
    .menu-bar {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-bottom: 18px;
    }
    .menu-bar button {
      font-size: 15px;
      padding: 7px 16px;
      border-radius: 18px;
      background: var(--gray);
      color: #444;
      border: 1px solid #e1e5e9;
      cursor: pointer;
      transition: background 0.3s;
    }
    [data-theme="dark"] .menu-bar button {
      background: #232340;
      color: var(--dark-text);
      border: 1px solid #393b6c;
    }
    .menu-bar .active {
      background: var(--primary);
      color: var(--white);
      border: 1px solid var(--primary);
    }
    .theme-toggle {
      background: none;
      border: none;
      font-size: 1.4rem;
      margin-left: 4px;
      cursor: pointer;
    }
    .security-note {
      background: #fff7e6;
      color: #b36b00;
      border-left: 5px solid var(--highlight);
      padding: 12px 18px;
      border-radius: 8px;
      margin-bottom: 18px;
      font-size: 1rem;
    }
    [data-theme="dark"] .security-note {
      background: #322e1a;
      color: #ffd180;
      border-color: #ffd180;
    }
    .profile-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    @media (max-width: 700px) {
      .profile-row { grid-template-columns: 1fr; gap: 10px; }
      .container { padding: 7px; }
      .card { padding: 14px 7px; }
    }
    .meal-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
    }
    .meal-table th, .meal-table td {
      border: 1px solid #ddd;
      padding: 7px 8px;
      text-align: left;
    }
    .meal-table th {
      background: var(--primary);
      color: var(--white);
      font-weight: 600;
    }
    [data-theme="dark"] .meal-table th {
      background: #363875;
      color: #ffe;
    }
    [data-theme="dark"] .meal-table td {
      background: #22223e;
      color: #eaeafd;
    }
    .budget-warning {
      color: #d63a3a;
      font-weight: bold;
      margin: 8px 0;
      font-size: 1.07em;
    }
    .budget-ok {
      color: #27ae60;
      font-weight: bold;
      margin: 8px 0;
      font-size: 1.07em;
    }
    .meal-desc {
      font-size: 0.97em;
      color: #666;
    }
    [data-theme="dark"] .meal-desc { color: #aaa; }
    .logout-btn {
      position: absolute;
      top: 15px;
      right: 18px;
      background: rgba(255,255,255,0.16);
      color: var(--secondary);
      border: none;
      padding: 7px 17px;
      border-radius: 18px;
      cursor: pointer;
      font-size: 1em;
    }
    [data-theme="dark"] .logout-btn {
      background: #232340;
      color: #ffb84d;
    }
    .recipe-link {
      color: var(--primary);
      text-decoration: underline;
      font-size: 0.98em;
      margin-left: 6px;
    }
    .recipe-link:hover { color: var(--secondary); }
    .toggle-switch {
      display: inline-block;
      width: 46px;
      height: 26px;
      position: relative;
      margin-left: 10px;
      vertical-align: middle;
    }
    .toggle-switch input { display: none; }
    .slider {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #ccc;
      border-radius: 26px;
      transition: background 0.3s;
    }
    .slider:before {
      content: "";
      position: absolute;
      height: 20px; width: 20px;
      left: 3px; bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: 0.3s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.09);
    }
    input:checked + .slider {
      background: var(--primary);
    }
    input:checked + .slider:before {
      transform: translateX(20px);
      background: #ffe;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="app-header">
      <h1>üçΩÔ∏è Smart Calorie & Meal Planner</h1>
      <p>Your personalized nutrition and meal planning assistant</p>
    </div>

    <button class="logout-btn hidden" id="logoutBtn" onclick="logout()">Logout</button>

    <!-- LOGIN / REGISTER -->
    <div id="auth-screen" class="card">
      <h2>Welcome! Sign Up or Log In</h2>
      <div class="security-note">
        <strong>Security Notice:</strong><br>
        This sign-in is for convenience only. <u>Do NOT use any real or sensitive passwords or PINs.</u><br>
        Your PIN and info are stored in your browser, not encrypted. This design is intentional to avoid risks in case of a data breach.
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" placeholder="e.g., john@example.com" autocomplete="username">
      </div>
      <div class="form-group">
        <label>4-Digit PIN</label>
        <input type="password" id="pin" placeholder="e.g., 1234" maxlength="4" pattern="\d{4}" inputmode="numeric" autocomplete="current-password">
      </div>
      <button class="btn btn-primary" onclick="login()" style="width: 100%; margin-bottom: 10px;">Login</button>
      <button class="btn btn-secondary" onclick="showRegister()" style="width: 100%;">Create New Account</button>
    </div>

    <!-- REGISTER SCREEN -->
    <div id="register-screen" class="card hidden">
      <h2>Create Your Account</h2>
      <div class="security-note">
        <strong>Security Notice:</strong><br>
        This sign-in is for convenience only. <u>Do NOT use any real or sensitive passwords or PINs.</u><br>
        Your PIN and info are stored in your browser, not encrypted. This design is intentional to avoid risks in case of a data breach.
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="reg-email" placeholder="e.g., john@example.com" autocomplete="username">
      </div>
      <div class="form-group">
        <label>4-Digit PIN</label>
        <input type="password" id="reg-pin" placeholder="e.g., 1234" maxlength="4" pattern="\d{4}" inputmode="numeric" autocomplete="new-password">
      </div>
      <div class="form-group">
        <label>Birthdate</label>
        <input type="date" id="reg-birthdate" max="">
      </div>
      <div class="form-group">
        <label>ZIP/Postal Code (US/CA)</label>
        <input type="text" id="reg-zip" maxlength="8" placeholder="e.g., 90210 or M5A 1A1">
      </div>
      <div class="profile-row">
        <div>
          <div class="form-group">
            <label>Weight (kg)</label>
            <input type="number" id="reg-weight" min="30" max="300" placeholder="e.g., 70">
          </div>
          <div class="form-group">
            <label>Height (cm)</label>
            <input type="number" id="reg-height" min="100" max="250" placeholder="e.g., 175">
          </div>
        </div>
        <div>
          <div class="form-group">
            <label>Gender</label>
            <select id="reg-gender">
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>
          <div class="form-group">
            <label>Activity Level</label>
            <select id="reg-activity">
              <option value="1.2">Sedentary</option>
              <option value="1.375">Light</option>
              <option value="1.55">Moderate</option>
              <option value="1.725">Active</option>
              <option value="1.9">Very Active</option>
            </select>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>Goal</label>
        <select id="reg-goal">
          <option value="maintain">Maintain Weight</option>
          <option value="lose">Lose Weight</option>
          <option value="gain">Gain Weight</option>
        </select>
      </div>
      <div class="form-group">
        <label>Weekly Food Budget ($)</label>
        <input type="number" id="reg-budget" min="10" max="500" value="75">
      </div>
      <div class="form-group">
        <label>Food Allergies/Intolerances (comma-separated)</label>
        <textarea id="reg-allergies" placeholder="e.g., nuts, dairy, gluten" rows="2"></textarea>
      </div>
      <button class="btn btn-primary" style="width:100%;" onclick="register()">Create Account</button>
      <button class="btn btn-secondary" style="width:100%;margin-top:8px;" onclick="showLogin()">Back to Login</button>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
      <div class="menu-bar">
        <button id="menu-btn-mealplan" class="active" onclick="showPanel('mealplan')">Meal Plan</button>
        <button id="menu-btn-profile" onclick="showPanel('profile')">Profile/Settings</button>
        <span>
          <label for="theme-switch" style="cursor:pointer;">
            <span id="theme-label">üåô</span>
            <span class="toggle-switch">
              <input type="checkbox" id="theme-switch" onchange="toggleTheme()">
              <span class="slider"></span>
            </span>
          </label>
        </span>
      </div>

      <!-- MEAL PLAN PANEL -->
      <div id="panel-mealplan">
        <div class="card">
          <h2>Your Personalized Meal Plan</h2>
          <div id="mealplan-content"></div>
        </div>
      </div>

      <!-- PROFILE PANEL -->
      <div id="panel-profile" class="hidden">
        <div class="card">
          <h2>Edit Profile & Preferences</h2>
          <form id="profile-form" onsubmit="saveProfile(); return false;">
            <div class="profile-row">
              <div>
                <div class="form-group">
                  <label>Email (cannot change)</label>
                  <input type="email" id="profile-email" disabled>
                </div>
                <div class="form-group">
                  <label>Birthdate</label>
                  <input type="date" id="profile-birthdate" max="">
                </div>
                <div class="form-group">
                  <label>ZIP/Postal Code (US/CA)</label>
                  <input type="text" id="profile-zip" maxlength="8">
                </div>
                <div class="form-group">
                  <label>Weekly Food Budget ($)</label>
                  <input type="number" id="profile-budget" min="10" max="500">
                </div>
              </div>
              <div>
                <div class="form-group">
                  <label>Weight (kg)</label>
                  <input type="number" id="profile-weight" min="30" max="300">
                </div>
                <div class="form-group">
                  <label>Height (cm)</label>
                  <input type="number" id="profile-height" min="100" max="250">
                </div>
                <div class="form-group">
                  <label>Gender</label>
                  <select id="profile-gender">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Activity Level</label>
                  <select id="profile-activity">
                    <option value="1.2">Sedentary</option>
                    <option value="1.375">Light</option>
                    <option value="1.55">Moderate</option>
                    <option value="1.725">Active</option>
                    <option value="1.9">Very Active</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Goal</label>
                  <select id="profile-goal">
                    <option value="maintain">Maintain Weight</option>
                    <option value="lose">Lose Weight</option>
                    <option value="gain">Gain Weight</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Food Allergies/Intolerances (comma-separated)</label>
              <textarea id="profile-allergies" rows="2"></textarea>
            </div>
            <button class="btn btn-primary" type="submit" style="width:100%;">Save & Update Meal Plan</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <script>
    // --- Simple region-based price modifiers (by US state code or Canadian province, fallback to 1.0) ---
    // For demo only, not real-time. In real use, connect to an API.
    const US_CA_REGION_PRICE_MODIFIERS = {
      // US
      "CA": 1.3, "NY": 1.23, "TX": 0.95, "FL": 1.02, "WA": 1.18, "AZ": 1.00, "IL": 1.10, "NC": 0.97, "GA": 0.97, "PA": 1.10, "OH": 1.05,
      // Canada
      "ON": 1.18, "QC": 1.16, "BC": 1.22, "AB": 1.02, "MB": 1.12, "NS": 1.15, "SK": 1.08, "NB": 1.14, "NL": 1.15, "PE": 1.13
    };

    // --- Meals Database (expandable; demo meals only) ---
    // Each meal: { name, calories, basePrice, type: breakfast/lunch/dinner/snack, regionAdj: true/false }
    const MEALS = [
      // Breakfast
      { name: "Scrambled Eggs & Toast", calories: 320, basePrice: 1.75, type: "breakfast" },
      { name: "Oatmeal with Fruit", calories: 290, basePrice: 1.15, type: "breakfast" },
      { name: "Greek Yogurt & Berries", calories: 210, basePrice: 2.25, type: "breakfast" },
      { name: "Banana Pancakes", calories: 350, basePrice: 2.00, type: "breakfast" },
      { name: "Avocado Toast", calories: 270, basePrice: 1.60, type: "breakfast" },
      // Lunch
      { name: "Rice & Beans Bowl", calories: 410, basePrice: 2.50, type: "lunch" },
      { name: "Turkey Sandwich", calories: 340, basePrice: 2.10, type: "lunch" },
      { name: "Chicken Salad", calories: 370, basePrice: 3.00, type: "lunch" },
      { name: "Veggie Wrap", calories: 320, basePrice: 2.30, type: "lunch" },
      { name: "Lentil Soup & Bread", calories: 330, basePrice: 2.40, type: "lunch" },
      // Dinner
      { name: "Spaghetti Marinara", calories: 450, basePrice: 2.75, type: "dinner" },
      { name: "Baked Chicken Thighs & Potatoes", calories: 520, basePrice: 3.80, type: "dinner" },
      { name: "Stir Fry Veggies & Rice", calories: 400, basePrice: 2.70, type: "dinner" },
      { name: "Turkey Meatballs & Pasta", calories: 480, basePrice: 3.50, type: "dinner" },
      { name: "Tofu Curry & Rice", calories: 390, basePrice: 2.90, type: "dinner" },
      // Snacks
      { name: "Apple & Peanut Butter", calories: 160, basePrice: 0.90, type: "snack" },
      { name: "Banana", calories: 95, basePrice: 0.55, type: "snack" },
      { name: "Carrots & Hummus", calories: 130, basePrice: 1.20, type: "snack" },
      { name: "String Cheese", calories: 80, basePrice: 0.80, type: "snack" },
      { name: "Trail Mix", calories: 170, basePrice: 1.10, type: "snack" }
    ];

    // --- User storage and session ---
    let users = {};
    let currentUser = null;
    let theme = 'light';

    function saveUsers() {
      localStorage.setItem('plannerUsers', JSON.stringify(users));
    }
    function loadUsers() {
      users = JSON.parse(localStorage.getItem('plannerUsers') || '{}');
    }
    function saveSession() {
      if(currentUser) localStorage.setItem('plannerCurrent', currentUser);
    }
    function loadSession() {
      currentUser = localStorage.getItem('plannerCurrent') || null;
    }
    function clearSession() {
      localStorage.removeItem('plannerCurrent');
    }
    function saveTheme(newTheme) {
      localStorage.setItem('plannerTheme', newTheme);
    }
    function loadTheme() {
      return localStorage.getItem('plannerTheme') || 'light';
    }

    // --- Theme handling ---
    function setTheme(newTheme) {
      theme = newTheme;
      document.documentElement.setAttribute('data-theme', theme);
      document.getElementById('theme-switch').checked = (theme === 'dark');
      document.getElementById('theme-label').textContent = theme === 'dark' ? 'üåô' : 'üåû';
      saveTheme(theme);
    }
    function toggleTheme() {
      setTheme(theme === 'light' ? 'dark' : 'light');
    }

    // --- UI Navigation ---
    function showPanel(panel) {
      document.getElementById('panel-mealplan').classList.toggle('hidden', panel !== 'mealplan');
      document.getElementById('panel-profile').classList.toggle('hidden', panel !== 'profile');
      document.getElementById('menu-btn-mealplan').classList.toggle('active', panel === 'mealplan');
      document.getElementById('menu-btn-profile').classList.toggle('active', panel === 'profile');
      if(panel === 'profile') loadProfileForm();
      if(panel === 'mealplan') renderMealPlan();
    }
    function showRegister() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.remove('hidden');
      document.getElementById('reg-birthdate').max = new Date().toISOString().split('T')[0];
    }
    function showLogin() {
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('auth-screen').classList.remove('hidden');
    }
    function showMainApp() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
      document.getElementById('logoutBtn').classList.remove('hidden');
      showPanel('mealplan');
    }

    // --- Auth ---
    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
    function validatePin(pin) {
      return /^\d{4}$/.test(pin);
    }
    function login() {
      loadUsers();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const pin = document.getElementById('pin').value.trim();
      if(!validateEmail(email)) return alert('Please enter a valid email.');
      if(!validatePin(pin)) return alert('PIN must be 4 digits.');
      if(users[email] && users[email].pin === pin) {
        currentUser = email;
        saveSession();
        showMainApp();
      } else {
        alert('Invalid email or PIN.');
      }
    }
    function register() {
      loadUsers();
      const email = document.getElementById('reg-email').value.trim().toLowerCase();
      const pin = document.getElementById('reg-pin').value.trim();
      const birthdate = document.getElementById('reg-birthdate').value;
      const zip = document.getElementById('reg-zip').value.trim().toUpperCase();
      const weight = parseFloat(document.getElementById('reg-weight').value);
      const height = parseFloat(document.getElementById('reg-height').value);
      const gender = document.getElementById('reg-gender').value;
      const activity = document.getElementById('reg-activity').value;
      const goal = document.getElementById('reg-goal').value;
      const budget = parseFloat(document.getElementById('reg-budget').value);
      const allergies = document.getElementById('reg-allergies').value.trim();
      if(!validateEmail(email)) return alert('Please enter a valid email.');
      if(!validatePin(pin)) return alert('PIN must be 4 digits.');
      if(users[email]) return alert('Account already exists.');
      if(!birthdate) return alert('Please enter your birthdate.');
      if(!zip) return alert('Please enter your ZIP or Postal Code.');
      if(!weight || !height) return alert('Please enter your weight and height.');
      users[email] = {
        pin, birthdate, zip, weight, height, gender, activity, goal, budget, allergies
      };
      saveUsers();
      currentUser = email;
      saveSession();
      showMainApp();
    }
    function logout() {
      clearSession();
      currentUser = null;
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('logoutBtn').classList.add('hidden');
      document.getElementById('auth-screen').classList.remove('hidden');
      document.getElementById('email').value = '';
      document.getElementById('pin').value = '';
    }

    // --- Profile Form Handling ---
    function loadProfileForm() {
      const user = getUser();
      if(!user) return;
      document.getElementById('profile-email').value = currentUser;
      document.getElementById('profile-birthdate').max = new Date().toISOString().split('T')[0];
      document.getElementById('profile-birthdate').value = user.birthdate || '';
      document.getElementById('profile-zip').value = user.zip || '';
      document.getElementById('profile-budget').value = user.budget || '';
      document.getElementById('profile-weight').value = user.weight || '';
      document.getElementById('profile-height').value = user.height || '';
      document.getElementById('profile-gender').value = user.gender || 'male';
      document.getElementById('profile-activity').value = user.activity || '1.2';
      document.getElementById('profile-goal').value = user.goal || 'maintain';
      document.getElementById('profile-allergies').value = user.allergies || '';
    }
    function saveProfile() {
      const user = getUser();
      user.birthdate = document.getElementById('profile-birthdate').value;
      user.zip = document.getElementById('profile-zip').value.trim().toUpperCase();
      user.budget = parseFloat(document.getElementById('profile-budget').value);
      user.weight = parseFloat(document.getElementById('profile-weight').value);
      user.height = parseFloat(document.getElementById('profile-height').value);
      user.gender = document.getElementById('profile-gender').value;
      user.activity = document.getElementById('profile-activity').value;
      user.goal = document.getElementById('profile-goal').value;
      user.allergies = document.getElementById('profile-allergies').value.trim();
      saveUsers();
      showPanel('mealplan');
      renderMealPlan();
      alert('Profile updated!');
    }

    // --- User helpers ---
    function getUser() {
      loadUsers();
      return currentUser ? users[currentUser] : null;
    }
    function getAgeFromBirthdate(birthdate) {
      if(!birthdate) return '';
      const diff = Date.now() - new Date(birthdate).getTime();
      return Math.floor(diff / (365.25 * 24 * 60 * 60 * 1000));
    }
    function extractRegion(zip) {
      // US: first 2 digits for state (rough), CA: first 2 letters for province
      if(!zip) return null;
      const z = zip.replace(/\s/g, '').toUpperCase();
      if(/^\d{5}(-\d{4})?$/.test(z)) { // US ZIP
        const stateFromZip = {
          '90': 'CA', '91': 'CA', '92': 'CA', '10': 'NY', '11': 'NY', '75': 'TX', '76': 'TX', '33': 'FL', '34': 'FL', '98': 'WA', '85': 'AZ', '60': 'IL', '27': 'NC', '30': 'GA', '15': 'PA', '43': 'OH'
          // ...add more as needed
        };
        return stateFromZip[z.substring(0,2)] || 'US';
      }
      if(/^[A-Z]\d[A-Z]/.test(z)) { // Canadian
        const provinceFromPC = {
          'M': 'ON', 'H': 'QC', 'V': 'BC', 'T': 'AB', 'R': 'MB', 'B': 'NS', 'S': 'SK', 'E': 'NB', 'A': 'NL', 'C': 'PE'
        };
        return provinceFromPC[z[0]] || 'CA';
      }
      return 'US';
    }
    function getPriceModifier(zip) {
      const region = extractRegion(zip);
      return US_CA_REGION_PRICE_MODIFIERS[region] || 1.0;
    }

    // --- Calories & TDEE ---
    function calculateCalories(user) {
      const age = getAgeFromBirthdate(user.birthdate);
      if(!age || !user.height || !user.weight) return 2000;
      let bmr;
      if(user.gender === 'male') {
        bmr = 88.362 + (13.397 * user.weight) + (4.799 * user.height) - (5.677 * age);
      } else {
        bmr = 447.593 + (9.247 * user.weight) + (3.098 * user.height) - (4.330 * age);
      }
      let tdee = bmr * parseFloat(user.activity || 1.2);
      if(user.goal === 'lose') tdee -= 500;
      else if(user.goal === 'gain') tdee += 300;
      return Math.max(1200, Math.round(tdee));
    }

    // --- Allergy Filtering ---
    function filterMealsByAllergies(meals, allergies) {
      if(!allergies) return meals.slice();
      const allergyList = allergies.toLowerCase().split(',').map(a => a.trim()).filter(a => a.length > 0);
      if(!allergyList.length) return meals.slice();
      return meals.filter(meal =>
        !allergyList.some(allergy =>
          meal.name.toLowerCase().includes(allergy)
        )
      );
    }

    // --- AI-style Meal Plan Generator (variety, budget, leftovers) ---
    function generateMealPlan(user) {
      const calTarget = calculateCalories(user);
      const zip = user.zip, budget = user.budget || 75;
      const priceMod = getPriceModifier(zip);
      const allergies = user.allergies;
      // 7 days, breakfast/lunch/dinner/snack
      const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
      const plan = [];
      let usedMeals = { breakfast: [], lunch: [], dinner: [], snack: [] }; // track for variety
      let leftovers = { breakfast: [], lunch: [], dinner: [], snack: [] };
      let totalCost = 0;
      let warning = "";

      // For each day, select meals with as much variety as possible, only repeat if needed for budget
      for(let d=0; d<7; ++d) {
        let dayMeals = [], dayCalories = 0, dayCost = 0;
        ['breakfast','lunch','dinner'].forEach(type => {
          // Try to pick a meal not used more than once yet
          let pool = filterMealsByAllergies(MEALS.filter(m => m.type === type), allergies)
            .filter(m => usedMeals[type].filter(u => u === m.name).length < 2);
          if(pool.length === 0) pool = filterMealsByAllergies(MEALS.filter(m => m.type === type), allergies); // allow repeats
          let meal = pool[Math.floor(Math.random()*pool.length)];
          if(!meal) return; // fallback
          // Price adjust
          const mealCost = Math.round(meal.basePrice * priceMod * 100)/100;
          // If over budget, try using leftovers (repeat a meal from previous day)
          if(totalCost + dayCost + mealCost > budget && leftovers[type].length) {
            meal = leftovers[type][0];
          }
          dayMeals.push({ ...meal, price: mealCost });
          dayCalories += meal.calories;
          dayCost += mealCost;
          usedMeals[type].push(meal.name);
        });
        // Snacks only if still under daily cal target and budget
        let snackPool = filterMealsByAllergies(MEALS.filter(m => m.type === 'snack'), allergies)
          .filter(m => usedMeals['snack'].filter(u => u === m.name).length < 2);
        if(snackPool.length > 0 && dayCalories < calTarget-100) {
          let snack = snackPool[Math.floor(Math.random()*snackPool.length)];
          const snackCost = Math.round(snack.basePrice * priceMod * 100)/100;
          if(totalCost + dayCost + snackCost <= budget) {
            dayMeals.push({ ...snack, price: snackCost });
            usedMeals['snack'].push(snack.name);
            dayCalories += snack.calories;
            dayCost += snackCost;
          }
        }
        // Add to leftovers for next day (simulate leftovers only for main meals, not snacks)
        ['breakfast','lunch','dinner'].forEach(type => {
          leftovers[type] = [dayMeals.find(m => m.type === type)]; // can eat yesterday's meal as leftover
        });
        totalCost += dayCost;
        plan.push({ day: days[d], meals: dayMeals, calories: dayCalories, cost: dayCost });
      }
      // If over budget, remove snacks until budget fits, then fallback to leftovers if needed (demo logic)
      let budgetTest = plan.reduce((sum, day) => sum+day.cost,0);
      if(budgetTest > budget) {
        for(let d=0; d<7; ++d) {
          let snacks = plan[d].meals.filter(m => m.type === 'snack');
          if(snacks.length) {
            plan[d].meals = plan[d].meals.filter(m => m.type !== 'snack');
            plan[d].cost -= snacks.reduce((s,m) => s+m.price,0);
            plan[d].calories -= snacks.reduce((s,m) => s+m.calories,0);
            budgetTest = plan.reduce((sum, day) => sum+day.cost,0);
            if(budgetTest <= budget) break;
          }
        }
      }
      // If still over budget, fallback to leftovers for breakfast/lunch/dinner
      if(budgetTest > budget) {
        for(let d=1; d<7; ++d) {
          ['breakfast','lunch','dinner'].forEach(type => {
            let prevMeal = plan[d-1].meals.find(m => m.type === type);
            if(prevMeal) {
              let idx = plan[d].meals.findIndex(m => m.type === type);
              if(idx >= 0) {
                plan[d].meals[idx] = prevMeal;
                plan[d].cost = plan[d].meals.reduce((sum,m) => sum+m.price,0);
                plan[d].calories = plan[d].meals.reduce((sum,m) => sum+m.calories,0);
              }
            }
          });
          budgetTest = plan.reduce((sum, day) => sum+day.cost,0);
          if(budgetTest <= budget) break;
        }
      }
      // Final warning if still over
      if(plan.reduce((sum, day) => sum+day.cost,0) > budget) {
        warning = "‚ö†Ô∏è Budget could not be met with these preferences. Please adjust your budget or profile.";
      }
      return { plan, totalCost: plan.reduce((sum, d) => sum+d.cost,0), calories: calTarget, warning };
    }

    // --- Meal Plan UI ---
    function renderMealPlan() {
      const user = getUser();
      if(!user) return;
      const { plan, totalCost, calories, warning } = generateMealPlan(user);
      const budget = user.budget || 75;
      let html = `
        <div>
          <strong>Calories Target:</strong> ${calories} kcal/day
          <br><strong>Budget:</strong> $${budget.toFixed(2)} / week
          <br><strong>Estimated total cost of this plan:</strong> $${totalCost.toFixed(2)}
          <div class="${totalCost > budget ? 'budget-warning':'budget-ok'}">
            ${totalCost > budget ? 'Over Budget!':'Within Budget'}
          </div>
          ${warning ? `<div class="budget-warning">${warning}</div>` : ''}
        </div>
        <div style="margin-top:18px;">
      `;
      html += `<table class="meal-table"><thead><tr><th>Day</th><th>Meal</th><th>Calories</th><th>Price</th></tr></thead><tbody>`;
      plan.forEach(day => {
        day.meals.forEach((meal,i) => {
          html += `<tr>
            ${i===0?`<td rowspan="${day.meals.length}">${day.day}</td>`:''}
            <td>${meal.type.charAt(0).toUpperCase()+meal.type.slice(1)}: ${meal.name}
              <a class="recipe-link" href="https://www.pinterest.com/search/pins/?q=${encodeURIComponent(meal.name)}%20recipe" target="_blank">(recipe)</a>
            </td>
            <td>${meal.calories}</td>
            <td>$${meal.price.toFixed(2)}</td>
          </tr>`;
        });
      });
      html += `</tbody></table></div>`;
      document.getElementById('mealplan-content').innerHTML = html;
    }

    // --- INIT ---
    function initApp() {
      // Date max for birthdate fields
      document.getElementById('reg-birthdate').max = new Date().toISOString().split('T')[0];
      document.getElementById('profile-birthdate').max = new Date().toISOString().split('T')[0];
      // Theme
      setTheme(loadTheme());
      document.getElementById('theme-switch').addEventListener('change', toggleTheme);
      // Try auto-login
      loadUsers();
      loadSession();
      if(currentUser && users[currentUser]) {
        showMainApp();
      }
    }

    window.onload = initApp;
  </script>
</body>
</html>