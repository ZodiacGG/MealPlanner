<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Calorie & Meal Planner</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root {
      --primary: #667eea; --secondary: #764ba2; --white: #fff; --black: #222;
      --gray: #f8f9fa; --light-bg: #f9f8ff; --dark-bg: #21223b; --dark-card: #292a3d;
      --dark-text: #eaeafd; --highlight: #ffae42;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      min-height: 100vh; color: var(--black);
      transition: background 0.4s, color 0.4s;
    }
    [data-theme="dark"] body { background: var(--dark-bg); color: var(--dark-text); }
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    .app-header { text-align: center; margin-bottom: 30px; color: var(--white);}
    .app-header h1 { font-size: 2.2rem; margin-bottom: 10px; text-shadow: 2px 2px 7px rgba(0,0,0,0.13);}
    .card {
      background: rgba(255,255,255,0.97); border-radius: 18px; padding: 28px 22px;
      margin-bottom: 22px; box-shadow: 0 8px 32px rgba(0,0,0,0.09);
      border: 1px solid rgba(255,255,255,0.17); position: relative; transition: background 0.4s, color 0.4s;
    }
    [data-theme="dark"] .card { background: var(--dark-card); color: var(--dark-text); border: 1px solid #38396c;}
    .form-group { margin-bottom: 16px; }
    label { display: block; margin-bottom: 7px; font-weight: 500; color: #4b4b4b;}
    [data-theme="dark"] label { color: var(--dark-text);}
    input, select, textarea {
      width: 100%; padding: 11px 14px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px;
      background: var(--white); color: var(--black); transition: border-color 0.3s, background 0.4s, color 0.4s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(102,126,234,0.10);
    }
    [data-theme="dark"] input, [data-theme="dark"] select, [data-theme="dark"] textarea {
      background: #26273e; color: var(--dark-text); border: 2px solid #333455;
    }
    .btn { padding: 11px 20px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-block; text-align: center; }
    .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: var(--white);}
    .btn-primary:hover { filter: brightness(1.05); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.21);}
    .btn-secondary { background: var(--gray); color: #444; border: 2px solid #e1e5e9;}
    .btn-secondary:hover { background: #e9ecef;}
    [data-theme="dark"] .btn-secondary { background: #242545; color: var(--dark-text); border: 2px solid #343656;}
    [data-theme="dark"] .btn-secondary:hover { background: #32345d;}
    .hidden { display: none !important;}
    .menu-bar { display: flex; gap: 12px; justify-content: flex-end; margin-bottom: 18px;}
    .menu-bar button { font-size: 15px; padding: 7px 16px; border-radius: 18px; background: var(--gray); color: #444; border: 1px solid #e1e5e9; cursor: pointer; transition: background 0.3s;}
    [data-theme="dark"] .menu-bar button { background: #232340; color: var(--dark-text); border: 1px solid #393b6c;}
    .menu-bar .active { background: var(--primary); color: var(--white); border: 1px solid var(--primary);}
    .theme-toggle { background: none; border: none; font-size: 1.4rem; margin-left: 4px; cursor: pointer;}
    .security-note {
      background: #fff7e6; color: #b36b00; border-left: 5px solid var(--highlight);
      padding: 12px 18px; border-radius: 8px; margin-bottom: 18px; font-size: 1rem;
    }
    [data-theme="dark"] .security-note { background: #322e1a; color: #ffd180; border-color: #ffd180;}
    .profile-row { display: grid; grid-template-columns: 1fr 1fr; gap: 18px;}
    @media (max-width: 700px) { .profile-row { grid-template-columns: 1fr; gap: 10px;} .container { padding: 7px; } .card { padding: 14px 7px; }}
    .meal-table { width: 100%; border-collapse: collapse; margin-bottom: 16px;}
    .meal-table th, .meal-table td { border: 1px solid #ddd; padding: 7px 8px; text-align: left;}
    .meal-table th { background: var(--primary); color: var(--white); font-weight: 600;}
    [data-theme="dark"] .meal-table th { background: #363875; color: #ffe;}
    [data-theme="dark"] .meal-table td { background: #22223e; color: #eaeafd;}
    .meal-desc { font-size: 0.97em; color: #666;}
    [data-theme="dark"] .meal-desc { color: #aaa;}
    .logout-btn {
      position: absolute; top: 15px; right: 18px;
      background: rgba(255,255,255,0.16); color: var(--secondary);
      border: none; padding: 7px 17px; border-radius: 18px; cursor: pointer; font-size: 1em;
    }
    [data-theme="dark"] .logout-btn { background: #232340; color: #ffb84d;}
    .meal-link { color: var(--primary); cursor:pointer; text-decoration: underline;}
    .meal-link:hover { color: var(--secondary);}
    .meal-recipe-content { background: #f7f7fa; padding:10px 12px; border-radius:7px; margin:7px 0; color:#222;}
    [data-theme="dark"] .meal-recipe-content { background: #232340; color: #ffe;}
    .toggle-switch { display: inline-block; width: 46px; height: 26px; position: relative; margin-left: 10px; vertical-align: middle;}
    .toggle-switch input { display: none;}
    .slider {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: #ccc; border-radius: 26px; transition: background 0.3s;
    }
    .slider:before {
      content: ""; position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px;
      background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.09);
    }
    input:checked + .slider { background: var(--primary);}
    input:checked + .slider:before { transform: translateX(20px); background: #ffe;}
    .no-plan-message { color: #b20000; font-size: 1.13em; font-weight: bold; margin: 16px 0;}
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="app-header">
      <h1>üçΩÔ∏è Smart Calorie & Meal Planner</h1>
      <p>Your personalized nutrition and meal planning assistant</p>
    </div>
    <button class="logout-btn hidden" id="logoutBtn" onclick="logout()">Logout</button>
    <!-- LOGIN / REGISTER -->
    <div id="auth-screen" class="card">
      <h2>Welcome! Sign Up or Log In</h2>
      <div class="security-note">
        <strong>Security Notice:</strong><br>
        This sign-in is for convenience only. <u>Do NOT use any real or sensitive passwords or PINs.</u><br>
        Your PIN and info are stored in your browser, not encrypted. This design is intentional to avoid risks in case of a data breach.
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" placeholder="e.g., john@example.com" autocomplete="username">
      </div>
      <div class="form-group">
        <label>4-Digit PIN</label>
        <input type="password" id="pin" placeholder="e.g., 1234" maxlength="4" pattern="\d{4}" inputmode="numeric" autocomplete="current-password">
      </div>
      <button class="btn btn-primary" onclick="login()" style="width: 100%; margin-bottom: 10px;">Login</button>
      <button class="btn btn-secondary" onclick="showRegister()" style="width: 100%;">Create New Account</button>
    </div>
    <!-- REGISTER SCREEN -->
    <div id="register-screen" class="card hidden">
      <h2>Create Your Account</h2>
      <div class="security-note">
        <strong>Security Notice:</strong><br>
        This sign-in is for convenience only. <u>Do NOT use any real or sensitive passwords or PINs.</u><br>
        Your PIN and info are stored in your browser, not encrypted. This design is intentional to avoid risks in case of a data breach.
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="reg-email" placeholder="e.g., john@example.com" autocomplete="username">
      </div>
      <div class="form-group">
        <label>4-Digit PIN</label>
        <input type="password" id="reg-pin" placeholder="e.g., 1234" maxlength="4" pattern="\d{4}" inputmode="numeric" autocomplete="new-password">
      </div>
      <div class="form-group">
        <label>Birthdate</label>
        <input type="date" id="reg-birthdate" max="">
      </div>
      <div class="form-group">
        <label>ZIP/Postal Code (US/CA)</label>
        <input type="text" id="reg-zip" maxlength="8" placeholder="e.g., 90210 or M5A 1A1">
      </div>
      <div class="profile-row">
        <div>
          <div class="form-group">
            <label>Weight (kg)</label>
            <input type="number" id="reg-weight" min="30" max="300" placeholder="e.g., 70">
          </div>
          <div class="form-group">
            <label>Height (cm)</label>
            <input type="number" id="reg-height" min="100" max="250" placeholder="e.g., 175">
          </div>
        </div>
        <div>
          <div class="form-group">
            <label>Gender</label>
            <select id="reg-gender">
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>
          <div class="form-group">
            <label>Activity Level</label>
            <select id="reg-activity">
              <option value="1.2">Sedentary</option>
              <option value="1.375">Light</option>
              <option value="1.55">Moderate</option>
              <option value="1.725">Active</option>
              <option value="1.9">Very Active</option>
            </select>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>Goal</label>
        <select id="reg-goal">
          <option value="maintain">Maintain Weight</option>
          <option value="lose">Lose Weight</option>
          <option value="gain">Gain Weight</option>
        </select>
      </div>
      <div class="form-group">
        <label>Weekly Food Budget ($)</label>
        <input type="number" id="reg-budget" min="10" max="500" value="75">
      </div>
      <div class="form-group">
        <label>Food Allergies/Intolerances (comma-separated)</label>
        <textarea id="reg-allergies" placeholder="e.g., nuts, dairy, gluten" rows="2"></textarea>
      </div>
      <button class="btn btn-primary" style="width:100%;" onclick="register()">Create Account</button>
      <button class="btn btn-secondary" style="width:100%;margin-top:8px;" onclick="showLogin()">Back to Login</button>
    </div>
    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
      <div class="menu-bar">
        <button id="menu-btn-mealplan" class="active" onclick="showPanel('mealplan')">Meal Plan</button>
        <button id="menu-btn-profile" onclick="showPanel('profile')">Profile/Settings</button>
        <span>
          <label for="theme-switch" style="cursor:pointer;">
            <span id="theme-label">üåô</span>
            <span class="toggle-switch">
              <input type="checkbox" id="theme-switch" onchange="toggleTheme()">
              <span class="slider"></span>
            </span>
          </label>
        </span>
      </div>
      <div id="panel-mealplan">
        <div class="card">
          <h2>Your Personalized Meal Plan</h2>
          <div id="mealplan-content"></div>
        </div>
      </div>
      <div id="panel-profile" class="hidden">
        <div class="card">
          <h2>Edit Profile & Preferences</h2>
          <form id="profile-form" onsubmit="saveProfile(); return false;">
            <div class="profile-row">
              <div>
                <div class="form-group">
                  <label>Email (cannot change)</label>
                  <input type="email" id="profile-email" disabled>
                </div>
                <div class="form-group">
                  <label>Birthdate</label>
                  <input type="date" id="profile-birthdate" max="">
                </div>
                <div class="form-group">
                  <label>ZIP/Postal Code (US/CA)</label>
                  <input type="text" id="profile-zip" maxlength="8">
                </div>
                <div class="form-group">
                  <label>Weekly Food Budget ($)</label>
                  <input type="number" id="profile-budget" min="10" max="500">
                </div>
              </div>
              <div>
                <div class="form-group">
                  <label>Weight (kg)</label>
                  <input type="number" id="profile-weight" min="30" max="300">
                </div>
                <div class="form-group">
                  <label>Height (cm)</label>
                  <input type="number" id="profile-height" min="100" max="250">
                </div>
                <div class="form-group">
                  <label>Gender</label>
                  <select id="profile-gender">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Activity Level</label>
                  <select id="profile-activity">
                    <option value="1.2">Sedentary</option>
                    <option value="1.375">Light</option>
                    <option value="1.55">Moderate</option>
                    <option value="1.725">Active</option>
                    <option value="1.9">Very Active</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Goal</label>
                  <select id="profile-goal">
                    <option value="maintain">Maintain Weight</option>
                    <option value="lose">Lose Weight</option>
                    <option value="gain">Gain Weight</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Food Allergies/Intolerances (comma-separated)</label>
              <textarea id="profile-allergies" rows="2"></textarea>
            </div>
            <button class="btn btn-primary" type="submit" style="width:100%;">Save & Update Meal Plan</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <script>
    // --- Simple region-based price modifiers (by US state code or Canadian province, fallback to 1.0) ---
    const US_CA_REGION_PRICE_MODIFIERS = {
      "CA": 1.3, "NY": 1.23, "TX": 0.95, "FL": 1.02, "WA": 1.18, "AZ": 1.00, "IL": 1.10, "NC": 0.97, "GA": 0.97, "PA": 1.10, "OH": 1.05,
      "ON": 1.18, "QC": 1.16, "BC": 1.22, "AB": 1.02, "MB": 1.12, "NS": 1.15, "SK": 1.08, "NB": 1.14, "NL": 1.15, "PE": 1.13
    };
    // --- Enriched meals database with macros and recipes ---
    const MEALS = [
      {
        name: "Scrambled Eggs & Toast", type: "breakfast",
        basePrice: 1.75, calories: 320, protein: 14, carbs: 28, fat: 13,
        recipe: {
          ingredients: [ "2 eggs", "2 slices whole wheat bread", "1 tsp butter", "Salt & pepper" ],
          steps: [
            "Whisk eggs with salt and pepper.",
            "Heat butter in pan and scramble eggs.",
            "Toast bread.",
            "Serve eggs with toast."
          ]
        }
      },
      {
        name: "Oatmeal with Fruit", type: "breakfast",
        basePrice: 1.15, calories: 290, protein: 8, carbs: 54, fat: 4,
        recipe: {
          ingredients: [ "1/2 cup rolled oats", "1 cup water or milk", "1/2 banana", "1/4 cup berries" ],
          steps: [
            "Combine oats and liquid, cook until soft.",
            "Top with sliced banana and berries."
          ]
        }
      },
      {
        name: "Greek Yogurt & Berries", type: "breakfast",
        basePrice: 2.25, calories: 210, protein: 15, carbs: 25, fat: 3,
        recipe: {
          ingredients: [ "1 cup nonfat Greek yogurt", "1/2 cup mixed berries", "1 tsp honey (optional)" ],
          steps: [
            "Spoon yogurt into bowl.",
            "Top with berries and drizzle honey."
          ]
        }
      },
      {
        name: "Banana Pancakes", type: "breakfast",
        basePrice: 2.00, calories: 350, protein: 10, carbs: 62, fat: 7,
        recipe: {
          ingredients: [ "1 ripe banana", "2 eggs", "1/2 cup flour", "1/2 tsp baking powder", "Splash milk", "Butter or oil for pan" ],
          steps: [
            "Mash banana and mix with eggs and milk.",
            "Stir in flour and baking powder.",
            "Cook pancakes on greased skillet until golden."
          ]
        }
      },
      {
        name: "Avocado Toast", type: "breakfast",
        basePrice: 1.60, calories: 270, protein: 7, carbs: 30, fat: 14,
        recipe: {
          ingredients: [ "2 slices whole wheat bread", "1/2 avocado", "Salt & pepper", "Lemon juice" ],
          steps: [
            "Toast bread.",
            "Mash avocado with lemon, salt, pepper.",
            "Spread avocado mixture on toast."
          ]
        }
      },
      {
        name: "Rice & Beans Bowl", type: "lunch",
        basePrice: 2.50, calories: 410, protein: 13, carbs: 80, fat: 4,
        recipe: {
          ingredients: [ "1 cup cooked rice", "1/2 cup cooked beans", "Salsa", "Chopped cilantro" ],
          steps: [
            "Warm rice and beans.",
            "Top with salsa and cilantro."
          ]
        }
      },
      {
        name: "Turkey Sandwich", type: "lunch",
        basePrice: 2.10, calories: 340, protein: 18, carbs: 38, fat: 9,
        recipe: {
          ingredients: [ "2 slices whole wheat bread", "3 slices deli turkey", "Lettuce", "Tomato", "1 tsp mayo" ],
          steps: [
            "Layer turkey, lettuce, tomato on bread.",
            "Spread mayo, assemble sandwich."
          ]
        }
      },
      {
        name: "Chicken Salad", type: "lunch",
        basePrice: 3.00, calories: 370, protein: 26, carbs: 11, fat: 22,
        recipe: {
          ingredients: [ "1 cup cooked, chopped chicken", "2 tbsp mayo", "Chopped celery", "Chopped onion", "Lettuce leaves" ],
          steps: [
            "Mix chicken, mayo, celery, onion.",
            "Serve on lettuce leaves."
          ]
        }
      },
      {
        name: "Veggie Wrap", type: "lunch",
        basePrice: 2.30, calories: 320, protein: 8, carbs: 46, fat: 9,
        recipe: {
          ingredients: [ "1 whole wheat tortilla", "1/2 cup hummus", "Shredded carrots", "Spinach", "Cucumber slices" ],
          steps: [
            "Spread hummus on tortilla.",
            "Layer veggies, roll up."
          ]
        }
      },
      {
        name: "Lentil Soup & Bread", type: "lunch",
        basePrice: 2.40, calories: 330, protein: 15, carbs: 52, fat: 4,
        recipe: {
          ingredients: [ "1 cup lentil soup", "1 slice whole wheat bread" ],
          steps: [
            "Heat soup, serve with bread."
          ]
        }
      },
      {
        name: "Spaghetti Marinara", type: "dinner",
        basePrice: 2.75, calories: 450, protein: 13, carbs: 78, fat: 7,
        recipe: {
          ingredients: [ "2 oz dry spaghetti", "1 cup marinara", "Parmesan (optional)", "Basil" ],
          steps: [
            "Cook spaghetti, heat marinara.",
            "Combine, top with parmesan and basil."
          ]
        }
      },
      {
        name: "Baked Chicken Thighs & Potatoes", type: "dinner",
        basePrice: 3.80, calories: 520, protein: 28, carbs: 32, fat: 27,
        recipe: {
          ingredients: [ "1 chicken thigh", "1 cup potatoes", "Olive oil", "Herbs, salt & pepper" ],
          steps: [
            "Toss potatoes in oil, herbs.",
            "Roast chicken and potatoes at 400¬∞F for 35min."
          ]
        }
      },
      {
        name: "Stir Fry Veggies & Rice", type: "dinner",
        basePrice: 2.70, calories: 400, protein: 8, carbs: 74, fat: 7,
        recipe: {
          ingredients: [ "1 cup rice", "2 cups mixed veggies", "Soy sauce", "1 tbsp oil" ],
          steps: [
            "Stir fry veggies in oil.",
            "Add cooked rice and soy sauce, stir until hot."
          ]
        }
      },
      {
        name: "Turkey Meatballs & Pasta", type: "dinner",
        basePrice: 3.50, calories: 480, protein: 25, carbs: 57, fat: 16,
        recipe: {
          ingredients: [ "3 turkey meatballs", "1 cup pasta", "1/2 cup marinara", "Parmesan" ],
          steps: [
            "Cook pasta, heat meatballs in marinara.",
            "Serve together with cheese."
          ]
        }
      },
      {
        name: "Tofu Curry & Rice", type: "dinner",
        basePrice: 2.90, calories: 390, protein: 14, carbs: 52, fat: 12,
        recipe: {
          ingredients: [ "1/2 block firm tofu", "1 cup cooked rice", "1/2 cup curry sauce", "Peas" ],
          steps: [
            "Cube tofu, cook in curry sauce with peas.",
            "Serve over rice."
          ]
        }
      },
      {
        name: "Apple & Peanut Butter", type: "snack",
        basePrice: 0.90, calories: 160, protein: 4, carbs: 29, fat: 6,
        recipe: {
          ingredients: [ "1 apple", "1 tbsp peanut butter" ],
          steps: [
            "Slice apple, dip in peanut butter."
          ]
        }
      },
      {
        name: "Banana", type: "snack",
        basePrice: 0.55, calories: 95, protein: 1, carbs: 24, fat: 0,
        recipe: {
          ingredients: [ "1 banana" ],
          steps: [
            "Peel and eat."
          ]
        }
      },
      {
        name: "Carrots & Hummus", type: "snack",
        basePrice: 1.20, calories: 130, protein: 3, carbs: 21, fat: 5,
        recipe: {
          ingredients: [ "1 cup carrot sticks", "2 tbsp hummus" ],
          steps: [
            "Dip carrots in hummus."
          ]
        }
      },
      {
        name: "String Cheese", type: "snack",
        basePrice: 0.80, calories: 80, protein: 7, carbs: 1, fat: 6,
        recipe: {
          ingredients: [ "1 stick string cheese" ],
          steps: [
            "Unwrap and eat."
          ]
        }
      },
      {
        name: "Trail Mix", type: "snack",
        basePrice: 1.10, calories: 170, protein: 5, carbs: 15, fat: 10,
        recipe: {
          ingredients: [ "1/4 cup trail mix" ],
          steps: [
            "Enjoy as a snack."
          ]
        }
      }
    ];
    let users = {};
    let currentUser = null;
    let theme = 'light';
    function saveUsers() { localStorage.setItem('plannerUsers', JSON.stringify(users)); }
    function loadUsers() { users = JSON.parse(localStorage.getItem('plannerUsers') || '{}'); }
    function saveSession() { if(currentUser) localStorage.setItem('plannerCurrent', currentUser); }
    function loadSession() { currentUser = localStorage.getItem('plannerCurrent') || null; }
    function clearSession() { localStorage.removeItem('plannerCurrent'); }
    function saveTheme(newTheme) { localStorage.setItem('plannerTheme', newTheme); }
    function loadTheme() { return localStorage.getItem('plannerTheme') || 'light'; }
    function setTheme(newTheme) {
      theme = newTheme;
      document.documentElement.setAttribute('data-theme', theme);
      document.getElementById('theme-switch').checked = (theme === 'dark');
      document.getElementById('theme-label').textContent = theme === 'dark' ? 'üåô' : 'üåû';
      saveTheme(theme);
    }
    function toggleTheme() { setTheme(theme === 'light' ? 'dark' : 'light'); }
    function showPanel(panel) {
      document.getElementById('panel-mealplan').classList.toggle('hidden', panel !== 'mealplan');
      document.getElementById('panel-profile').classList.toggle('hidden', panel !== 'profile');
      document.getElementById('menu-btn-mealplan').classList.toggle('active', panel === 'mealplan');
      document.getElementById('menu-btn-profile').classList.toggle('active', panel === 'profile');
      if(panel === 'profile') loadProfileForm();
      if(panel === 'mealplan') renderMealPlan();
    }
    function showRegister() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.remove('hidden');
      document.getElementById('reg-birthdate').max = new Date().toISOString().split('T')[0];
    }
    function showLogin() {
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('auth-screen').classList.remove('hidden');
    }
    function showMainApp() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
      document.getElementById('logoutBtn').classList.remove('hidden');
      showPanel('mealplan');
    }
    function validateEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);}
    function validatePin(pin) { return /^\d{4}$/.test(pin);}
    function login() {
      loadUsers();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const pin = document.getElementById('pin').value.trim();
      if(!validateEmail(email)) return alert('Please enter a valid email.');
      if(!validatePin(pin)) return alert('PIN must be 4 digits.');
      if(users[email] && users[email].pin === pin) {
        currentUser = email;
        saveSession();
        showMainApp();
      } else {
        alert('Invalid email or PIN.');
      }
    }
    function register() {
      loadUsers();
      const email = document.getElementById('reg-email').value.trim().toLowerCase();
      const pin = document.getElementById('reg-pin').value.trim();
      const birthdate = document.getElementById('reg-birthdate').value;
      const zip = document.getElementById('reg-zip').value.trim().toUpperCase();
      const weight = parseFloat(document.getElementById('reg-weight').value);
      const height = parseFloat(document.getElementById('reg-height').value);
      const gender = document.getElementById('reg-gender').value;
      const activity = document.getElementById('reg-activity').value;
      const goal = document.getElementById('reg-goal').value;
      const budget = parseFloat(document.getElementById('reg-budget').value);
      const allergies = document.getElementById('reg-allergies').value.trim();
      if(!validateEmail(email)) return alert('Please enter a valid email.');
      if(!validatePin(pin)) return alert('PIN must be 4 digits.');
      if(users[email]) return alert('Account already exists.');
      if(!birthdate) return alert('Please enter your birthdate.');
      if(!zip) return alert('Please enter your ZIP or Postal Code.');
      if(!weight || !height) return alert('Please enter your weight and height.');
      users[email] = {
        pin, birthdate, zip, weight, height, gender, activity, goal, budget, allergies
      };
      saveUsers();
      currentUser = email;
      saveSession();
      showMainApp();
    }
    function logout() {
      clearSession();
      currentUser = null;
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('logoutBtn').classList.add('hidden');
      document.getElementById('auth-screen').classList.remove('hidden');
      document.getElementById('email').value = '';
      document.getElementById('pin').value = '';
    }
    function loadProfileForm() {
      const user = getUser();
      if(!user) return;
      document.getElementById('profile-email').value = currentUser;
      document.getElementById('profile-birthdate').max = new Date().toISOString().split('T')[0];
      document.getElementById('profile-birthdate').value = user.birthdate || '';
      document.getElementById('profile-zip').value = user.zip || '';
      document.getElementById('profile-budget').value = user.budget || '';
      document.getElementById('profile-weight').value = user.weight || '';
      document.getElementById('profile-height').value = user.height || '';
      document.getElementById('profile-gender').value = user.gender || 'male';
      document.getElementById('profile-activity').value = user.activity || '1.2';
      document.getElementById('profile-goal').value = user.goal || 'maintain';
      document.getElementById('profile-allergies').value = user.allergies || '';
    }
    function saveProfile() {
      const user = getUser();
      user.birthdate = document.getElementById('profile-birthdate').value;
      user.zip = document.getElementById('profile-zip').value.trim().toUpperCase();
      user.budget = parseFloat(document.getElementById('profile-budget').value);
      user.weight = parseFloat(document.getElementById('profile-weight').value);
      user.height = parseFloat(document.getElementById('profile-height').value);
      user.gender = document.getElementById('profile-gender').value;
      user.activity = document.getElementById('profile-activity').value;
      user.goal = document.getElementById('profile-goal').value;
      user.allergies = document.getElementById('profile-allergies').value.trim();
      saveUsers();
      showPanel('mealplan');
      renderMealPlan();
      alert('Profile updated!');
    }
    function getUser() { loadUsers(); return currentUser ? users[currentUser] : null;}
    function getAgeFromBirthdate(birthdate) {
      if(!birthdate) return '';
      const diff = Date.now() - new Date(birthdate).getTime();
      return Math.floor(diff / (365.25 * 24 * 60 * 60 * 1000));
    }
    function extractRegion(zip) {
      if(!zip) return null;
      const z = zip.replace(/\s/g, '').toUpperCase();
      if(/^\d{5}(-\d{4})?$/.test(z)) {
        const stateFromZip = {
          '90': 'CA', '91': 'CA', '92': 'CA', '10': 'NY', '11': 'NY', '75': 'TX', '76': 'TX', '33': 'FL', '34': 'FL', '98': 'WA', '85': 'AZ', '60': 'IL', '27': 'NC', '30': 'GA', '15': 'PA', '43': 'OH'
        };
        return stateFromZip[z.substring(0,2)] || 'US';
      }
      if(/^[A-Z]\d[A-Z]/.test(z)) {
        const provinceFromPC = {
          'M': 'ON', 'H': 'QC', 'V': 'BC', 'T': 'AB', 'R': 'MB', 'B': 'NS', 'S': 'SK', 'E': 'NB', 'A': 'NL', 'C': 'PE'
        };
        return provinceFromPC[z[0]] || 'CA';
      }
      return 'US';
    }
    function getPriceModifier(zip) {
      const region = extractRegion(zip);
      return US_CA_REGION_PRICE_MODIFIERS[region] || 1.0;
    }
    function calculateCalories(user) {
      const age = getAgeFromBirthdate(user.birthdate);
      if(!age || !user.height || !user.weight) return 2000;
      let bmr;
      if(user.gender === 'male') {
        bmr = 88.362 + (13.397 * user.weight) + (4.799 * user.height) - (5.677 * age);
      } else {
        bmr = 447.593 + (9.247 * user.weight) + (3.098 * user.height) - (4.330 * age);
      }
      let tdee = bmr * parseFloat(user.activity || 1.2);
      if(user.goal === 'lose') tdee -= 500;
      else if(user.goal === 'gain') tdee += 300;
      return Math.max(1200, Math.round(tdee));
    }
    function filterMealsByAllergies(meals, allergies) {
      if(!allergies) return meals.slice();
      const allergyList = allergies.toLowerCase().split(',').map(a => a.trim()).filter(a => a.length > 0);
      if(!allergyList.length) return meals.slice();
      return meals.filter(meal =>
        !allergyList.some(allergy =>
          meal.name.toLowerCase().includes(allergy)
        )
      );
    }
    function generateMealPlan(user) {
      const calTarget = calculateCalories(user);
      const zip = user.zip, budget = user.budget || 75;
      const priceMod = getPriceModifier(zip);
      const allergies = user.allergies;
      const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
      let bestPlan = null;
      let bestCost = Infinity;
      for(let attempt=0; attempt<25; ++attempt) {
        let usedMeals = { breakfast: [], lunch: [], dinner: [], snack: [] };
        let leftovers = { breakfast: [], lunch: [], dinner: [], snack: [] };
        let plan = [];
        let totalCost = 0;
        let failed = false;
        for(let d=0; d<7; ++d) {
          let dayMeals = [], dayCalories = 0, dayCost = 0;
          for(let mealType of ['breakfast','lunch','dinner']) {
            let pool = filterMealsByAllergies(MEALS.filter(m => m.type === mealType), allergies)
              .filter(m => usedMeals[mealType].filter(u => u === m.name).length < 2);
            if(pool.length === 0) pool = filterMealsByAllergies(MEALS.filter(m => m.type === mealType), allergies);
            let meal = pool[Math.floor(Math.random()*pool.length)];
            if(!meal) { failed = true; break; }
            const mealCost = Math.round(meal.basePrice * priceMod * 100)/100;
            if(totalCost + dayCost + mealCost > budget && leftovers[mealType].length) {
              meal = leftovers[mealType][0];
            }
            const mealActualCost = Math.round(meal.basePrice * priceMod * 100)/100;
            if(totalCost + dayCost + mealActualCost > budget) { failed = true; break; }
            dayMeals.push({ ...meal, price: mealActualCost });
            dayCalories += meal.calories;
            dayCost += mealActualCost;
            usedMeals[mealType].push(meal.name);
          }
          let snackPool = filterMealsByAllergies(MEALS.filter(m => m.type === 'snack'), allergies)
            .filter(m => usedMeals['snack'].filter(u => u === m.name).length < 2);
          if(snackPool.length > 0 && dayCalories < calTarget-100) {
            let snack = snackPool[Math.floor(Math.random()*snackPool.length)];
            const snackCost = Math.round(snack.basePrice * priceMod * 100)/100;
            if(totalCost + dayCost + snackCost <= budget) {
              dayMeals.push({ ...snack, price: snackCost });
              usedMeals['snack'].push(snack.name);
              dayCalories += snack.calories;
              dayCost += snackCost;
            }
          }
          ['breakfast','lunch','dinner'].forEach(type => {
            leftovers[type] = [dayMeals.find(m => m.type === type)];
          });
          totalCost += dayCost;
          plan.push({ day: days[d], meals: dayMeals, calories: dayCalories, cost: dayCost });
        }
        if(!failed && totalCost <= budget && totalCost < bestCost) {
          bestPlan = { plan, totalCost, calories: calTarget };
          bestCost = totalCost;
        }
      }
      return bestPlan;
    }
    function renderMealPlan() {
      const user = getUser();
      if(!user) return;
      const result = generateMealPlan(user);
      const budget = user.budget || 75;
      let html = `<div>
          <strong>Calories Target:</strong> ${calculateCalories(user)} kcal/day
          <br><strong>Your Budget:</strong> $${budget.toFixed(2)} / week
        </div><div style="margin-top:18px;">`;
      if(!result) {
        html += `<div class="no-plan-message">No meal plan can be generated under your current budget and preferences.<br>Please increase your budget or relax restrictions.</div>`;
      } else {
        html += `<strong>Plan Total Cost:</strong> $${result.totalCost.toFixed(2)}<br>`;
        html += `<table class="meal-table"><thead><tr><th>Day</th><th>Meal</th><th>Calories</th><th>Protein</th><th>Carbs</th><th>Fat</th><th>Price</th></tr></thead><tbody>`;
        result.plan.forEach(day => {
          day.meals.forEach((meal,i) => {
            html += `<tr>
              ${i===0?`<td rowspan="${day.meals.length}">${day.day}</td>`:''}
              <td>
                <span class="meal-link" onclick="toggleRecipe('${meal.name.replace(/'/g,"\\'")}')">${meal.name}</span>
                <div class="meal-recipe-content hidden" id="rec_${meal.name.replace(/[^a-zA-Z0-9]/g,'_')}"></div>
              </td>
              <td>${meal.calories}</td>
              <td>${meal.protein}g</td>
              <td>${meal.carbs}g</td>
              <td>${meal.fat}g</td>
              <td>$${meal.price ? meal.price.toFixed(2):'?'}</td>
            </tr>`;
          });
        });
        html += `</tbody></table>`;
      }
      html += `</div>`;
      document.getElementById('mealplan-content').innerHTML = html;
    }
    function toggleRecipe(name) {
      const meal = MEALS.find(m => m.name === name);
      if(!meal) return;
      const id = `rec_${name.replace(/[^a-zA-Z0-9]/g,'_')}`;
      const el = document.getElementById(id);
      if(!el) return;
      if(!el.innerHTML) {
        el.innerHTML = `
          <div>
            <strong>Ingredients:</strong>
            <ul>${meal.recipe.ingredients.map(ing=>`<li>${ing}</li>`).join('')}</ul>
            <strong>Steps:</strong>
            <ol>${meal.recipe.steps.map(step=>`<li>${step}</li>`).join('')}</ol>
            <strong>Macros:</strong> ${meal.protein}g protein, ${meal.carbs}g carbs, ${meal.fat}g fat, ${meal.calories} kcal
          </div>
        `;
      }
      el.classList.toggle('hidden');
    }
    window.toggleRecipe = toggleRecipe;
    function initApp() {
      document.getElementById('reg-birthdate').max = new Date().toISOString().split('T')[0];
      document.getElementById('profile-birthdate').max = new Date().toISOString().split('T')[0];
      setTheme(loadTheme());
      document.getElementById('theme-switch').addEventListener('change', toggleTheme);
      loadUsers();
      loadSession();
      if(currentUser && users[currentUser]) showMainApp();
    }
    window.onload = initApp;
  </script>
</body>
</html>